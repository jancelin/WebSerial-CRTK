<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <title>Centipede Web Serial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="static/logo.png" />
  <style>
    :root {
      --primary: #0b57d0;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
    }

    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 16px;
      background-color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-size: 1.8rem;
      margin: 24px 0;
      text-align: center;
      color: var(--dark)
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .brand .logo {
      height: 2.5em;
      width: auto;
    }

    .main-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1)
    }

    .control-group {
      margin-bottom: 20px
    }

    .control-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark)
    }

    .control-row {
      display: flex;
      gap: 16px;
      align-items: flex-end;
      flex-wrap: wrap
    }

    select,
    input[type="number"],
    input[type="file"] {
      font-size: 16px;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #ddd;
      background: #fff;
      width: 100%;
      max-width: none;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: var(--primary)
    }

    .btn {
      font-size: 16px;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white
    }

    .btn-primary:hover {
      background: #0943a6
    }

    .btn-success {
      background: var(--success);
      color: white
    }

    .btn-success:hover {
      background: #218838
    }

    .btn[disabled] {
      opacity: .6;
      cursor: not-allowed
    }

    .progress-container {
      margin-top: 24px;
      position: relative;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .progress-info-btn {
      background: none;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      transition: all 0.2s;
    }

    .progress-info-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .uart-terminal {
      background: #1a1a1a;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 12px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 12px;
      border: 1px solid #333;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .uart-terminal::-webkit-scrollbar {
      width: 8px;
    }

    .uart-terminal::-webkit-scrollbar-track {
      background: #2a2a2a;
    }

    .uart-terminal::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    .uart-terminal .sent {
      color: #ffff00;
    }

    .uart-terminal .received {
      color: #00ff00;
    }

    .uart-terminal .timestamp {
      color: #888;
      font-size: 10px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 12px
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #4285f4);
      transition: width 0.3s ease;
      border-radius: 10px
    }

    .progress-text {
      text-align: center;
      font-size: 14px;
      color: var(--dark)
    }

    .settings-menu {
      position: relative;
      display: inline-block
    }

    .settings-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s
    }

    .settings-btn:hover {
      background: #f0f0f0
    }

    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(2px);
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: background 0.2s;
      color: #666;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #f0f0f0;
      color: var(--danger);
    }

    .settings-content select,
    .settings-content input[type="number"],
    .settings-content input[type="file"] {
      width: 100%;
      max-width: none;
      box-sizing: border-box;
      font-size: 16px;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #ddd;
      background: #fff;
      margin: 0;
    }

    .file-group {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px
    }

    .refresh-btn {
      padding: 8px;
      background: none;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px
    }

    .refresh-btn:hover {
      background: #f0f0f0
    }

    footer {
      margin-top: auto;
      padding: 16px 0;
      border-top: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 14px;
      color: #666
    }

    footer a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      color: var(--primary)
    }

    footer svg {
      width: 16px;
      height: 16px
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 0;
      margin-top: 16px;
      font-weight: 500
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb
    }

    .hidden {
      display: none
    }

    .config-description {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.5;
      color: #495057;
    }

    .config-description h4 {
      margin: 0 0 10px 0;
      color: #007bff;
      font-size: 16px;
    }

    .config-description p {
      margin: 0 0 8px 0;
    }

    .config-description p:last-child {
      margin-bottom: 0;
    }

    /* Mode Switch Styles */
    .mode-switch-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
      background: white;
      border-radius: 25px;
      padding: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
    }

    .mode-switch {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--dark);
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--primary);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    .mode-label {
      font-weight: 600;
      white-space: nowrap;
    }

    .mode-label.active {
      color: var(--primary);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .mode-switch-container {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 16px;
        justify-content: center;
        display: flex;
      }
    }
  </style>
</head>

<body>
  <!-- Mode Switch -->
  <div class="mode-switch-container">
    <div class="mode-switch">
      <span class="mode-label active" id="beginnerLabel">D√©butant</span>
      <label class="switch">
        <input type="checkbox" id="modeToggle">
        <span class="slider"></span>
      </label>
      <span class="mode-label" id="advancedLabel">Avanc√©</span>
    </div>
  </div>

  <div class="main-content">
    <h1 class="brand">
      <img src="static/logo.png" alt="Logo" class="logo" />
      Centipede-RTK Web Serial
    </h1>

    <div class="main-container">
      <!-- Boutons principaux -->
      <div class="control-group">
        <div class="control-row">
          <button id="connect" class="btn btn-primary" style="flex: 1;">üîå Connecter</button>
          <button id="disconnect" class="btn btn-primary hidden" disabled style="flex: 1;">‚èèÔ∏è D√©connecter</button>
          <button id="upload" class="btn btn-success" disabled style="flex: 1;">üì§ T√©l√©verser</button>
        </div>
      </div>

      <!-- Contr√¥les de configuration -->
      <div class="control-group">
        <div class="control-row">
          <div style="flex: 1; height : 75px;">
            <label>Vitesse de transmission</label>
            <select id="baud">
              <option>4800</option>
              <option>9600</option>
              <option>19200</option>
              <option>28800</option>
              <option>38400</option>
              <option>57600</option>
              <option>76800</option>
              <option selected>115200</option>
              <option>230400</option>
              <option>460800</option>
              <option>576000</option>
              <option>921600</option>
            </select>
          </div>
          <div style="flex: 1; height : 75px;">
            <label>Configurations</label>
            <div class="file-group">
              <select id="configSelect">
                <option value="">‚Äî Choisir une configuration ‚Äî</option>
              </select>
              <button id="refreshList" class="refresh-btn" title="Rafra√Æchir la liste">‚Üª</button>
            </div>
          </div>
          <div style="flex: 0 0 auto; height : 75px;">
            <label>&nbsp;</label>
            <div class="settings-menu">
              <button class="settings-btn" id="settingsToggle" title="Param√®tres avanc√©s">‚öôÔ∏è</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Zone de description -->
      <div class="control-group" id="configDescriptionContainer" style="display: none;">
        <div class="config-description" id="configDescription">
          <!-- Description dynamique -->
        </div>
      </div>

      <!-- Barre de progression -->
      <div class="progress-container hidden" id="progressContainer">
        <div class="progress-header">
          <div></div>
          <button class="progress-info-btn" id="terminalToggle" title="Afficher/masquer le terminal UART">i</button>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progressText">En attente...</div>
        <div class="uart-terminal hidden" id="uartTerminal"></div>
      </div>

      <!-- Status -->
      <div id="status" class="status info">
        Pr√™t √† se connecter
      </div>
    </div>

    <!-- Modale des param√®tres -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <div class="modal-header">
          <h2 class="modal-title">Param√®tres avanc√©s</h2>
          <button class="close-btn" id="closeModal" title="Fermer">‚úï</button>
        </div>

        <div class="control-group">
          <label>Fin de ligne</label>
          <select id="eol">
            <option value="\r\n" selected>CRLF</option>
            <option value="\n">LF</option>
            <option value="\r">CR</option>
          </select>
        </div>

        <div class="control-group">
          <label>D√©lai entre commande(s)</label>
          <input id="delay" type="number" min="0" step="0.1" value="5">
        </div>

        <div class="control-group">
          <label>Charger un fichier personnel</label>
          <input id="configFile" type="file" accept=".txt,.cfg,.conf,.ini,.log,.nmea,.csv,.*" />
        </div>

        <div class="control-group">
          <button id="save" class="btn btn-primary" style="width:100%;margin-top:8px">üíæ SAVECONFIG</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <span>¬© 2025 by Centipede-RTK</span>
    <a href="https://github.com/jancelin/WebSerial-CRTK" target="_blank" rel="noopener">
      <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
        <path fill="currentColor"
          d="M8 .2a8 8 0 0 0-2.53 15.59c.4.07.55-.17.55-.38v-1.34c-2.25.49-2.72-1.08-2.72-1.08-.37-.95-.9-1.2-.9-1.2-.74-.51.06-.5.06-.5.82.06 1.25.85 1.25.85.73 1.24 1.92.88 2.39.67.07-.53.28-.88.5-1.08-1.8-.2-3.7-.9-3.7-4a3.14 3.14 0 0 1 .84-2.18 2.9 2.9 0 0 1 .08-2.15s.68-.22 2.22.83a7.6 7.6 0 0 1 4.05 0c1.54-1.05 2.22-.83 2.22-.83.45 1.08.17 1.89.09 2.09a3.13 3.13 0 0 1 .84 2.18c0 3.11-1.9 3.8-3.71 4 .29.25.54.73.54 1.48v2.2c0 .21.15.45.55.38A8 8 0 0 0 8 .2Z" />
      </svg>
      github.com/jancelin/Webserial-CRTK
    </a>
  </footer>

  <script>
    /* ---------------------- Helpers UI ---------------------- */
    const $ = s => document.querySelector(s);
    let currentConfig = '';
    let isConnected = false;
    let terminalVisible = false;

    // Mode switch functionality - Simple redirection
    document.addEventListener('DOMContentLoaded', () => {
      const modeToggle = $('#modeToggle');

      // Handle mode switch
      modeToggle.onchange = () => {
        if (modeToggle.checked) {
          // Switch to advanced mode - redirect to advanced page
          localStorage.setItem('centipede-mode', 'advanced');
          window.location.href = 'index_advanced.html';
        }
      };
    });

    function updateStatus(message, type = 'info') {
      const statusEl = $('#status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    function showProgress(show = true) {
      const container = $('#progressContainer');
      if (show) {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
        // Masquer aussi le terminal quand on masque la barre de progression
        $('#uartTerminal').classList.add('hidden');
        terminalVisible = false;
      }
    }

    function updateProgress(percentage, text) {
      $('#progressFill').style.width = percentage + '%';
      $('#progressText').textContent = text;
    }

    function toggleTerminal() {
      const terminal = $('#uartTerminal');
      terminalVisible = !terminalVisible;

      if (terminalVisible) {
        terminal.classList.remove('hidden');
      } else {
        terminal.classList.add('hidden');
      }
    }

    function addToTerminal(message, type = 'info') {
      const terminal = $('#uartTerminal');
      const timestamp = new Date().toLocaleTimeString('fr-FR', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        fractionalSecondDigits: 3
      });

      let prefix = '';
      let cssClass = '';

      switch (type) {
        case 'sent':
          prefix = '‚Üí TX: ';
          cssClass = 'sent';
          break;
        case 'received':
          prefix = '‚Üê RX: ';
          cssClass = 'received';
          break;
        default:
          prefix = '‚Ä¢ ';
          break;
      }

      const line = document.createElement('div');
      line.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="${cssClass}">${prefix}${escapeHtml(message)}</span>`;
      terminal.appendChild(line);

      // Auto-scroll vers le bas
      terminal.scrollTop = terminal.scrollHeight;

      // Limiter le nombre de lignes (garder seulement les 200 derni√®res)
      const lines = terminal.children;
      if (lines.length > 200) {
        terminal.removeChild(lines[0]);
      }
    }

    function clearTerminal() {
      $('#uartTerminal').innerHTML = '';
    }

    function getEOL() {
      return eval('`' + $('#eol').value + '`');
    }

    // Fonction pour extraire la description depuis les commentaires du fichier
    function extractConfigDescription(content) {
      if (!content) return null;

      const lines = content.split('\n');
      const description = {
        title: '',
        details: []
      };

      // Recherche des tags #title: et #content: dans les commentaires
      for (let i = 0; i < Math.min(30, lines.length); i++) {
        const line = lines[i].trim();

        // Ignorer les lignes vides
        if (!line) continue;

        // Si c'est un commentaire (# ou //)
        if (line.startsWith('#') || line.startsWith('//')) {
          const comment = line.replace(/^(#|\/\/)\s*/, '');

          // Rechercher le tag title:
          if (comment.toLowerCase().startsWith('title:')) {
            description.title = comment.substring(6).trim();
          }
          // Rechercher le tag content:
          else if (comment.toLowerCase().startsWith('content:')) {
            const content = comment.substring(8).trim();
            if (content.length > 0) {
              description.details.push(content);
            }
          }
        } else {
          // Si on rencontre une ligne non-commentaire et qu'on a d√©j√† des donn√©es, on arr√™te
          if (description.title || description.details.length > 0) {
            break;
          }
        }
      }

      return (description.title || description.details.length) ? description : null;
    }

    // Fonction pour afficher la description
    function displayConfigDescription(description) {
      const container = $('#configDescriptionContainer');
      const descElement = $('#configDescription');

      if (!description) {
        container.style.display = 'none';
        return;
      }

      let html = '';
      if (description.title) {
        html += `<h4>${convertUrlsToLinks(escapeHtml(description.title))}</h4>`;
      }

      if (description.details.length > 0) {
        description.details.forEach(detail => {
          html += `<p>${convertUrlsToLinks(escapeHtml(detail))}</p>`;
        });
      }

      descElement.innerHTML = html;
      container.style.display = 'block';
    }

    // Fonction utilitaire pour √©chapper le HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Fonction pour convertir les URLs en liens cliquables
    function convertUrlsToLinks(text) {
      // Expression r√©guli√®re pour d√©tecter les URLs
      const urlRegex = /(https?:\/\/[^\s<>"]+)/gi;

      return text.replace(urlRegex, function (url) {
        // Nettoyer l'URL pour enlever la ponctuation finale √©ventuelle
        let cleanUrl = url;
        const punctuation = /[.,!?;:]$/;
        let endPunct = '';

        if (punctuation.test(url)) {
          endPunct = url.slice(-1);
          cleanUrl = url.slice(0, -1);
        }

        return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: underline;">${cleanUrl}</a>${endPunct}`;
      });
    }

    // Toggle settings modal
    $('#settingsToggle').onclick = () => {
      const modal = $('#settingsModal');
      modal.classList.add('active');
    };

    // Toggle terminal
    $('#terminalToggle').onclick = () => {
      toggleTerminal();
    };

    // Close modal
    $('#closeModal').onclick = () => {
      const modal = $('#settingsModal');
      modal.classList.remove('active');
    };

    // Close modal when clicking on backdrop
    $('#settingsModal').onclick = (e) => {
      if (e.target === $('#settingsModal')) {
        $('#settingsModal').classList.remove('active');
      }
    };

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        $('#settingsModal').classList.remove('active');
      }
    });

    /* ---------------------- Web Serial state ---------------------- */
    let port, reader, writer;
    let textDecoder, textEncoder;
    let readableStreamClosed, writableStreamClosed;
    let sendingBatch = false;

    function ensureWebSerial() {
      if (!('serial' in navigator)) {
        updateStatus('Web Serial non support√© dans ce navigateur. Utilisez Chrome/Chromium desktop.', 'error');
        throw new Error('Web Serial unsupported');
      }
    }

    /* ---------------------- Connect / Disconnect ---------------------- */
    $('#connect').onclick = async () => {
      try {
        ensureWebSerial();
        const baudRate = parseInt($('#baud').value, 10) || 115200;

        updateStatus('Connexion en cours...', 'info');

        // Filtres USB : FTDI(0x0403), CP210x(0x10C4), CH340(0x1A86)
        const filters = [{ usbVendorId: 0x0403 }, { usbVendorId: 0x10C4 }, { usbVendorId: 0x1A86 }];
        port = await navigator.serial.requestPort({ filters });
        await port.open({ baudRate });

        // Streams enc/dec et "pipes" avec suivi pour fermeture propre
        textDecoder = new TextDecoderStream();
        readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();

        textEncoder = new TextEncoderStream();
        writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
        writer = textEncoder.writable.getWriter();

        // Boucle de lecture (termin√©e par reader.cancel() √† la d√©connexion)
        (async function readLoop() {
          try {
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              // Afficher les donn√©es re√ßues dans le terminal si visible
              if (value && value.length > 0) {
                addToTerminal(value, 'received');
              }
            }
          } catch (e) {
            updateStatus('Erreur de lecture: ' + e.message, 'error');
          }
        })();

        isConnected = true;
        $('#connect').classList.add('hidden');
        $('#disconnect').classList.remove('hidden');
        $('#disconnect').disabled = false;
        $('#upload').disabled = !currentConfig;
        updateStatus(`Connect√© @ ${baudRate} bauds`, 'success');
      } catch (e) {
        updateStatus('Erreur de connexion: ' + (e?.message || e), 'error');
      }
    };

    $('#disconnect').onclick = async () => {
      try {
        if (!port) return;
        if (sendingBatch) {
          updateStatus('Envoi en cours ‚Äî attente avant d√©connexion‚Ä¶', 'info');
        }

        // 1) Arr√™ter proprement la lecture
        try { await reader?.cancel(); } catch { }
        try { await readableStreamClosed?.catch(() => { }); } catch { }
        reader?.releaseLock?.();

        // 2) Fermer proprement l'√©criture
        try { await writer?.close(); } catch { }
        try { await writableStreamClosed?.catch(() => { }); } catch { }
        writer?.releaseLock?.();

        // 3) Fermer le port
        await port.close();

        // 4) Nettoyage d'√©tat
        port = undefined; reader = undefined; writer = undefined;
        textDecoder = textEncoder = undefined;
        readableStreamClosed = writableStreamClosed = undefined;

        isConnected = false;
        $('#connect').classList.remove('hidden');
        $('#disconnect').classList.add('hidden');
        $('#disconnect').disabled = true;
        $('#upload').disabled = true;
        showProgress(false);
        updateStatus('D√©connect√©', 'info');
      } catch (e) {
        updateStatus('Erreur de d√©connexion: ' + (e?.message || e), 'error');
      }
    };

    /* ---------------------- Listing des fichiers de conf ---------------------- */
    // Repo GitHub (adapter si tu renommes le d√©p√¥t ou l'owner)
    const GH_OWNER = 'jancelin';
    const GH_REPO = 'WebSerial-CRTK';
    // Essaie ces branches dans l'ordre
    const GH_BRANCH_CANDIDATES = ['gh-pages', 'main', 'master'];
    // Extensions autoris√©es
    const ALLOWED_EXT = /\.(txt|cfg|conf|ini|nmea|csv|log)$/i;

    // Rafra√Æchir manuellement
    $('#refreshList').onclick = () => populateConfigSelect(true);

    // Appel automatique au chargement de la page
    document.addEventListener('DOMContentLoaded', () => populateConfigSelect(false));

    async function populateConfigSelect(manual) {
      const sel = $('#configSelect');
      sel.innerHTML = '<option value="" disabled selected>‚Äî Choisir une configuration ‚Äî</option>';

      // 0) Tentative: fichier manifeste optionnel (si tu ajoutes conf_files/index.json)
      //    Format attendu: ["Feasycom_BT836b.txt","UM980_rover_fullNMEA_5hz_BT921600bd_UP_STABLE.txt", ...]
      const manifestFiles = await tryFetchManifestJSON();
      if (manifestFiles && manifestFiles.length) {
        addOptions(sel, manifestFiles.map(n => ({ name: n, url: 'conf_files/' + n })));
        updateStatus(`${manifestFiles.length} fichier(s) de configuration trouv√©(s)`, 'success');
        return;
      }

      // 1) En local: listing HTML (python -m http.server)
      const localFiles = await tryFetchLocalIndex();
      if (localFiles && localFiles.length) {
        addOptions(sel, localFiles.map(n => ({ name: n, url: 'conf_files/' + n })));
        updateStatus(`${localFiles.length} fichier(s) de configuration d√©tect√©(s).`, 'success');
        return;
      }

      // 2) Fallback GitHub API (utile sur GitHub Pages)
      const ghFiles = await tryFetchGitHubAPI();
      if (ghFiles && ghFiles.length) {
        addOptions(sel, ghFiles); // ghFiles contient {name, url:download_url}
        updateStatus(`${ghFiles.length} fichier(s) de configuration via GitHub API`, 'success');
        return;
      }

      updateStatus(manual ? 'Aucun fichier de configuration d√©tect√©.' :
        'Impossible de lister conf_files/ (auto-index ou API). Utilisez le bouton "fichier personnel".', 'info');
    }

    function addOptions(selectEl, items) {
      // items: [{name:'file.txt', url:'...'}]
      items
        .filter(it => ALLOWED_EXT.test(it.name))
        .sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }))
        .forEach(it => {
          const opt = document.createElement('option');
          opt.value = it.url;
          // Nettoyer le nom : supprimer l'extension et remplacer _ par des espaces
          const cleanName = it.name.replace(/\.[^/.]+$/, '').replace(/_/g, ' ');
          opt.textContent = cleanName;
          selectEl.appendChild(opt);
        });
    }

    async function tryFetchManifestJSON() {
      try {
        const resp = await fetch('conf_files/index.json?t=' + Date.now(), { cache: 'no-store' });
        if (!resp.ok) return null;
        const arr = await resp.json();
        return (Array.isArray(arr) ? arr.filter(n => typeof n === 'string') : null);
      } catch { return null; }
    }

    async function tryFetchLocalIndex() {
      try {
        const resp = await fetch('conf_files/?t=' + Date.now(), { cache: 'no-store' });
        if (!resp.ok) return null;
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        let files = Array.from(doc.querySelectorAll('a[href]'))
          .map(a => a.getAttribute('href') || '')
          .filter(href => href && !href.startsWith('?') && !href.startsWith('/'))
          .filter(href => !href.endsWith('/'))
          .filter(href => ALLOWED_EXT.test(href));
        return files;
      } catch { return null; }
    }

    async function tryFetchGitHubAPI() {
      for (const branch of GH_BRANCH_CANDIDATES) {
        try {
          const apiUrl = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/conf_files?ref=${encodeURIComponent(branch)}`;
          const apiResp = await fetch(apiUrl, { cache: 'no-store' });
          if (!apiResp.ok) continue;
          const items = await apiResp.json();
          const files = (Array.isArray(items) ? items : [])
            .filter(it => it && it.type === 'file' && typeof it.name === 'string' && typeof it.download_url === 'string')
            .filter(it => ALLOWED_EXT.test(it.name))
            .map(it => ({ name: it.name, url: it.download_url }));
          if (files.length) return files;
        } catch { /* essaye la branche suivante */ }
      }
      return null;
    }

    /* ---------------------- Chargement fichier s√©lectionn√© / perso ---------------------- */
    $('#configSelect').onchange = async (ev) => {
      const url = ev.target.value;
      if (!url) {
        currentConfig = '';
        $('#upload').disabled = true;
        displayConfigDescription(null);
        return;
      }
      try {
        updateStatus('Chargement de la configuration...', 'info');
        const resp = await fetch(url, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const txt = await resp.text();
        currentConfig = normalizeText(txt);
        $('#upload').disabled = !isConnected;
        updateStatus('Configuration charg√©e: ' + url.split('/').pop(), 'success');

        // Extraire et afficher la description
        const description = extractConfigDescription(txt);
        displayConfigDescription(description);
      } catch (e) {
        updateStatus('Impossible de charger ' + url + ' : ' + (e?.message || e), 'error');
        currentConfig = '';
        $('#upload').disabled = true;
        displayConfigDescription(null);
      }
    };

    // Fichier perso (local)
    $('#configFile').onchange = async (ev) => {
      const f = ev.target.files?.[0];
      if (!f) {
        currentConfig = '';
        $('#upload').disabled = true;
        displayConfigDescription(null);
        return;
      }
      try {
        updateStatus('Chargement du fichier...', 'info');
        const txt = await f.text();
        currentConfig = normalizeText(txt);
        $('#configSelect').value = ''; // d√©s√©lectionner le menu conf_files
        $('#upload').disabled = !isConnected;
        updateStatus('Fichier charg√©: ' + f.name, 'success');

        // Extraire et afficher la description
        const description = extractConfigDescription(txt);
        displayConfigDescription(description);
      } catch (e) {
        updateStatus('Erreur lecture fichier: ' + (e?.message || e), 'error');
        currentConfig = '';
        $('#upload').disabled = true;
        displayConfigDescription(null);
      }
    };

    function normalizeText(t) {
      // Normalise fins de ligne & supprime BOM
      return t.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim() + '\n';
    }

    /* ---------------------- Upload des commandes ---------------------- */
    $('#upload').onclick = async () => {
      if (!writer) {
        updateStatus('Non connect√©.', 'error');
        return;
      }
      if (!currentConfig) {
        updateStatus('Aucune configuration charg√©e.', 'error');
        return;
      }
      if (sendingBatch) {
        updateStatus('Envoi d√©j√† en cours. Patientez...', 'info');
        return;
      }

      const lines = currentConfig.split('\n')
        .map(s => s.trim())
        .filter(s => s.length && !s.startsWith('#') && !s.startsWith('//') && !s.startsWith(';'));

      if (!lines.length) {
        updateStatus('Aucune commande valide dans la configuration.', 'error');
        return;
      }

      const delaySec = Math.max(0, parseFloat($('#delay').value || '5') || 5);
      const eol = getEOL();

      sendingBatch = true;
      $('#upload').disabled = true;
      showProgress(true);

      try {
        updateStatus(`Envoi de ${lines.length} commande(s)...`, 'info');
        updateProgress(0, 'D√©marrage...');

        // Effacer le terminal et ajouter un message de d√©but
        clearTerminal();
        addToTerminal(`=== D√©but de la configuration (${lines.length} commandes) ===`);

        for (let i = 0; i < lines.length; i++) {
          const cmd = lines[i];
          await writer.write(cmd + eol);

          // Afficher la commande envoy√©e dans le terminal
          addToTerminal(cmd + eol.replace(/\n/g, '\\n').replace(/\r/g, '\\r'), 'sent');

          const progress = ((i + 1) / lines.length) * 100;
          updateProgress(progress, `Commande ${i + 1}/${lines.length}: ${cmd.substring(0, 30)}${cmd.length > 30 ? '...' : ''}`);

          if (i < lines.length - 1) {
            await sleep(delaySec * 1000);
          }
        }

        updateProgress(100, 'Configuration envoy√©e avec succ√®s!');
        updateStatus('Configuration envoy√©e avec succ√®s!', 'success');
        addToTerminal('=== Fin de la configuration ===');

        // Masquer la barre de progression apr√®s 3 secondes
        setTimeout(() => showProgress(false), 3000);
      } catch (e) {
        updateStatus('Erreur lors de l\'envoi: ' + (e?.message || e), 'error');
        showProgress(false);
      } finally {
        sendingBatch = false;
        $('#upload').disabled = !currentConfig || !isConnected;
      }
    };

    $('#save').onclick = async () => {
      if (!writer) {
        updateStatus('Non connect√©.', 'error');
        return;
      }
      try {
        const command = 'SAVECONFIG' + getEOL();
        await writer.write(command);
        addToTerminal(command.replace(/\n/g, '\\n').replace(/\r/g, '\\r'), 'sent');
        updateStatus('Commande SAVECONFIG envoy√©e', 'success');
      } catch (e) {
        updateStatus('Erreur SAVECONFIG: ' + (e?.message || e), 'error');
      }
    };

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
  </script>
</body>

</html>