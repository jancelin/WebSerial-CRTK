<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Centipede-RTK Web Serial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pad: 12px; --gap: 12px; }
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:1000px;margin:24px auto;padding:0 16px}
    h1{font-size:1.6rem;margin:0 0 12px}
    .brand{display:flex; align-items:baseline; gap:10px;}
    .brand .logo{height:2em; width:auto; vertical-align:middle;}
    .row{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap;margin:8px 0}
    .grow{flex:1 1 auto}
    label{display:flex;align-items:center;gap:8px}
    select,input[type="number"],input[type="file"],button{font-size:14px;padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff}
    button{cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    textarea{width:100%;height:200px;padding:10px;border-radius:8px;border:1px solid #ccc;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    #log{white-space:pre-wrap;background:#111;color:#eee;padding:10px;height:280px;overflow:auto;border-radius:8px}
    .muted{opacity:0.7}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    footer{margin-top:16px; padding-top:10px; border-top:1px solid #eee; display:flex; align-items:center; gap:12px; font-size:14px; color:#555;}
    footer a{display:inline-flex; align-items:center; gap:6px; text-decoration:none; color:#0b57d0;}
    footer svg{width:16px; height:16px; display:inline-block;}
  </style>
</head>
<body>
  <h1 class="brand">
    <img src="static/logo.png" alt="Logo" class="logo" />
    Centipede-RTK Web Serial
  </h1>

  <div class="row">
    <button id="connect">üîå Connecter</button>
    <button id="disconnect" disabled>‚èèÔ∏è D√©connecter</button>

    <label>Baud
      <select id="baud">
        <option>4800</option>
        <option>9600</option>
        <option>19200</option>
        <option>28800</option>
        <option>38400</option>
        <option>57600</option>
        <option>76800</option>
        <option selected>115200</option>
        <option>230400</option>
        <option>460800</option>
        <option>576000</option>
        <option>921600</option>
      </select>
    </label>

    <label>Fin de ligne
      <select id="eol">
        <option value="\r\n" selected>CRLF</option>
        <option value="\n">LF</option>
        <option value="\r">CR</option>
      </select>
    </label>

    <label>D√©lai entre commandes (s)
      <input id="delay" type="number" min="0" step="0.1" value="5">
    </label>
  </div>

  <div class="row">
    <label>Fichier de configuration
      <select id="configSelect">
        <option value="">‚Äî Choisir un fichier (conf_files) ‚Äî</option>
      </select>
    </label>

    <label>ou charger un fichier personnel
      <input id="configFile" type="file" accept=".txt,.cfg,.conf,.ini,.log,.nmea,.csv,.*" />
    </label>
  </div>

  <textarea id="cmd" placeholder="Collez/√©ditez vos commandes ici (une par ligne). Les lignes vides et celles commen√ßant par #, // ou ; seront ignor√©es."></textarea>

  <div class="toolbar">
    <button id="send">‚û°Ô∏è Envoyer (multi-lignes)</button>
    <button id="save">üíæ SAVECONFIG</button>
    <button id="clear">üßπ Effacer le log</button>
    <span class="muted">Astuce : gardez CRLF si requis par le firmware.</span>
  </div>

  <pre id="log">‚Äî Log ‚Äî</pre>

  <footer>
    <span>¬© 2025 by Centipede-RTK</span>
    <a href="https://github.com/jancelin/WebSerial-CRTK" target="_blank" rel="noopener">
      <!-- Petit logo GitHub (SVG inline) -->
      <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
        <path fill="currentColor" d="M8 .2a8 8 0 0 0-2.53 15.59c.4.07.55-.17.55-.38v-1.34c-2.25.49-2.72-1.08-2.72-1.08-.37-.95-.9-1.2-.9-1.2-.74-.51.06-.5.06-.5.82.06 1.25.85 1.25.85.73 1.24 1.92.88 2.39.67.07-.53.28-.88.5-1.08-1.8-.2-3.7-.9-3.7-4a3.14 3.14 0 0 1 .84-2.18 2.9 2.9 0 0 1 .08-2.15s.68-.22 2.22.83a7.6 7.6 0 0 1 4.05 0c1.54-1.05 2.22-.83 2.22-.83.45 1.08.17 1.89.09 2.09a3.13 3.13 0 0 1 .84 2.18c0 3.11-1.9 3.8-3.71 4 .29.25.54.73.54 1.48v2.2c0 .21.15.45.55.38A8 8 0 0 0 8 .2Z"/>
      </svg>
      https://github.com/jancelin/WebSerial-CRTK
    </a>
  </footer>

<script>
/* ---------------------- Helpers UI ---------------------- */
const $ = s => document.querySelector(s);
const logEl = $('#log');
function logLine(s) { logEl.textContent += (s ?? '') + '\n'; logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent = '‚Äî Log ‚Äî\n'; }
function getEOL(){ return eval('`' + $('#eol').value + '`'); } // transforme "\r\n" en CRLF r√©el
// --- GitHub repo config (adapter si besoin) ---
const GH_OWNER  = 'jancelin';
const GH_REPO   = 'WebSerial-CRTK';s
// On essaie ces branches dans l'ordre :
const GH_BRANCH_CANDIDATES = ['gh-pages', 'main'];
// Extensions autoris√©es pour les fichiers de conf :
const ALLOWED_EXT = /\.(txt|cfg|conf|ini|nmea|csv|log)$/i;


/* ---------------------- Web Serial state ---------------------- */
let port, reader, writer;
let textDecoder, textEncoder;
let readableStreamClosed, writableStreamClosed;
let sendingBatch = false;

function ensureWebSerial(){
  if (!('serial' in navigator)) {
    alert('Web Serial non support√© dans ce navigateur. Utilisez Chrome/Chromium desktop.');
    throw new Error('Web Serial unsupported');
  }
}

/* ---------------------- Connect / Disconnect ---------------------- */
$('#connect').onclick = async () => {
  try {
    ensureWebSerial();
    const baudRate = parseInt($('#baud').value, 10) || 115200;

    // Filtres USB : FTDI(0x0403), CP210x(0x10C4), CH340(0x1A86)
    const filters = [{usbVendorId:0x0403},{usbVendorId:0x10C4},{usbVendorId:0x1A86}];
    port = await navigator.serial.requestPort({ filters });
    await port.open({ baudRate });

    // Streams enc/dec et "pipes" avec suivi pour fermeture propre
    textDecoder = new TextDecoderStream();
    readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
    reader = textDecoder.readable.getReader();

    textEncoder = new TextEncoderStream();
    writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
    writer = textEncoder.writable.getWriter();

    // Boucle de lecture (termin√©e par reader.cancel() √† la d√©connexion)
    (async function readLoop(){
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) logLine(value);
        }
      } catch (e) {
        logLine('‚úó Lecture: ' + e.message);
      }
    })();

    $('#connect').disabled = true;
    $('#disconnect').disabled = false;
    logLine('‚úì Connect√© @ ' + baudRate + ' bauds');
  } catch (e) {
    logLine('‚úó Erreur connexion: ' + (e?.message || e));
  }
};

$('#disconnect').onclick = async () => {
  try {
    if (!port) return;
    if (sendingBatch) logLine('‚ÑπÔ∏è Envoi en cours ‚Äî attente avant d√©connexion‚Ä¶');

    // 1) Arr√™ter proprement la lecture
    try { await reader?.cancel(); } catch {}
    try { await readableStreamClosed?.catch(()=>{}); } catch {}
    reader?.releaseLock?.();

    // 2) Fermer proprement l‚Äô√©criture
    try { await writer?.close(); } catch {}
    try { await writableStreamClosed?.catch(()=>{}); } catch {}
    writer?.releaseLock?.();

    // 3) Fermer le port
    await port.close();

    // 4) Nettoyage d‚Äô√©tat
    port = undefined; reader = undefined; writer = undefined;
    textDecoder = textEncoder = undefined;
    readableStreamClosed = writableStreamClosed = undefined;

    $('#connect').disabled = false;
    $('#disconnect').disabled = true;
    logLine('‚èèÔ∏è D√©connect√©');
  } catch (e) {
    logLine('‚úó D√©connexion: ' + (e?.message || e));
  }
};

/* ---------------------- Load config files ---------------------- */
// Extensions autoris√©es
const ALLOWED_EXT = /\.(txt|cfg|conf|ini|nmea|csv|log)$/i;

// Remplit la liste depuis le listing de /conf_files/ (http.server fournit un index HTML)
async function populateConfigSelect(){
  const sel = $('#configSelect');
  sel.innerHTML = '<option value="">‚Äî Choisir un fichier (conf_files) ‚Äî</option>';

  // 1) ESSAI: listing HTML (fonctionne en local avec http.server)
  try {
    const resp = await fetch('conf_files/', { cache: 'no-store' });
    if (resp.ok) {
      const html = await resp.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      let files = Array.from(doc.querySelectorAll('a[href]'))
        .map(a => a.getAttribute('href') || '')
        .filter(href => href && !href.startsWith('?') && !href.startsWith('/'))
        .filter(href => !href.endsWith('/'))
        .filter(href => ALLOWED_EXT.test(href))
        .sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));

      for (const f of files) {
        const opt = document.createElement('option');
        opt.value = 'conf_files/' + f;   // URL relative locale
        opt.textContent = f;
        sel.appendChild(opt);
      }
      if (files.length) { logLine(`‚úì ${files.length} fichier(s) d√©tect√©(s) (local).`); return; }
    }
    // si resp non-ok, on laisse tomber et on tente l'API GitHub
  } catch (_) {
    // ignore, on tente l‚ÄôAPI
  }

  // 2) FALLBACK: GitHub API (utile sur GitHub Pages)
  for (const branch of GH_BRANCH_CANDIDATES) {
    try {
      const apiUrl = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/conf_files?ref=${branch}`;
      const apiResp = await fetch(apiUrl, { cache: 'no-store' });
      if (!apiResp.ok) continue;
      const items = await apiResp.json();
      const files = (Array.isArray(items) ? items : [])
        .filter(it => it.type === 'file' && ALLOWED_EXT.test(it.name));

      files.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

      for (const it of files) {
        const opt = document.createElement('option');
        // Utilise le lien RAW fourni par l‚ÄôAPI (CORS ok) :
        opt.value = it.download_url;
        opt.textContent = it.name;
        sel.appendChild(opt);
      }
      if (files.length) { 
        logLine(`‚úì ${files.length} fichier(s) d√©tect√©(s) via GitHub API (${branch}).`);
        return;
      }
    } catch (e) {
      // on essaie la branche suivante
    }
  }

  logLine('‚ÑπÔ∏è Aucun listing accessible. Utilisez le bouton ‚Äúfichier personnel‚Äù.');
}

// Appel automatique au chargement de la page
document.addEventListener('DOMContentLoaded', populateConfigSelect);

// Chargement depuis la liste
$('#configSelect').onchange = async (ev) => {
  const url = ev.target.value;
  if (!url) return;
  try {
    const resp = await fetch(url, {cache:'no-store'});
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const txt = await resp.text();
    $('#cmd').value = normalizeText(txt);
    logLine('‚úì Charg√©: ' + url);
  } catch (e) {
    logLine('‚úó Impossible de charger ' + url + ' : ' + (e?.message || e));
  }
};

// Fichier perso (local)
$('#configFile').onchange = async (ev) => {
  const f = ev.target.files?.[0];
  if (!f) return;
  try {
    const txt = await f.text();
    $('#cmd').value = normalizeText(txt);
    $('#configSelect').value = ''; // d√©s√©lectionner le menu conf_files
    logLine('‚úì Fichier charg√©: ' + f.name);
  } catch (e) {
    logLine('‚úó Lecture fichier: ' + (e?.message || e));
  }
};

function normalizeText(t){
  // Normalise fins de ligne & supprime BOM
  return t.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim() + '\n';
}

/* ---------------------- Sending commands ---------------------- */
$('#send').onclick = async () => {
  if (!writer) { logLine('‚úó Non connect√©.'); return; }
  if (sendingBatch) { logLine('‚åõ D√©j√† en cours. Patiente‚Ä¶'); return; }

  const raw = $('#cmd').value || '';
  let lines = raw.split('\n')
    .map(s => s.trim())
    .filter(s => s.length && !s.startsWith('#') && !s.startsWith('//') && !s.startsWith(';'));

  if (!lines.length) { logLine('‚ÑπÔ∏è Rien √† envoyer.'); return; }

  const delaySec = Math.max(0, parseFloat($('#delay').value || '5') || 5);
  const eol = getEOL();

  sendingBatch = true;
  $('#send').disabled = true;
  try {
    logLine(`‚ñ∂Ô∏è Envoi de ${lines.length} commande(s), d√©lai ${delaySec}s‚Ä¶`);
    for (let i=0; i<lines.length; i++){
      const cmd = lines[i];
      await writer.write(cmd + eol);
      logLine(`‚Üí [${i+1}/${lines.length}] ${cmd}`);
      if (i < lines.length - 1) await sleep(delaySec * 1000);
    }
    logLine('‚úÖ Lot termin√©.');
  } catch (e) {
    logLine('‚úó Envoi interrompu: ' + (e?.message || e));
  } finally {
    sendingBatch = false;
    $('#send').disabled = false;
  }
};

$('#save').onclick = async () => {
  if (!writer) { logLine('‚úó Non connect√©.'); return; }
  try {
    await writer.write('SAVECONFIG' + getEOL());
    logLine('‚Üí SAVECONFIG');
  } catch (e) { logLine('‚úó SAVECONFIG: ' + (e?.message || e)); }
};

$('#clear').onclick = () => clearLog();

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>

